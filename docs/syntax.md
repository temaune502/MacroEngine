# Синтаксис мови TML

TML (Task Macro Language) — це компільована скриптова мова з байт-код віртуальною машиною (VM). Вона оптимізована для швидкого виконання макросів та надійності.

## Як працює TML
1. **Компіляція**: Коли ви запускаєте макрос, початковий код спочатку проходить через статичний аналізатор, а потім компілюється у байт-код.
2. **Кешування**: Скомпільований байт-код зберігається у папці `.cache`. При наступному запуску того самого макросу він завантажується миттєво, без повторної компіляції.
3. **Виконання**: Байт-код виконується віртуальною машиною. Вона має ліміт інструкцій на один ігровий такт (tick), що запобігає зависанню інтерфейсу навіть при складних обчисленнях.

## Продуктивність та Кешування

### Байт-код Кеш
TML автоматично кешує скомпільовані скрипти. 
- Кеш прив'язаний до вмісту файлу (використовується MD5 хеш). Будь-яка зміна у коді автоматично оновить кеш при наступному запуску.
- Файли кешу зберігаються 7 днів, після чого автоматично видаляються для економії місця.

### Оптимізації VM
Віртуальна машина TML використовує кілька технік для швидкої роботи:
- **Peephole Optimization**: Компілятор об'єднує кілька інструкцій в одну швидку (наприклад, `SET_LOCAL` + `POP` стає `SET_LOCAL_POP`).
- **Швидкі Операнди**: Для частих операцій, таких як `x = x + 1` або робота з властивостями об'єктів (наприклад, `mouse.x`), існують спеціальні оптимізовані інструкції.
- **Інструкційний ліміт**: VM виконує до 1000 інструкцій за один такт. Якщо макрос перевищує цей ліміт, він автоматично "засинає" до наступного такту, щоб не блокувати головний потік програми.

## Основні конструкції

### Змінні
Для оголошення та зміни змінних використовуються ключові слова `let` та `set`.
```python
let x = 10        # Оголошення нової змінної
set x = 20        # Зміна значення існуючої змінної
```

### Типи даних
- **Числа**: `10`, `3.14`
- **Рядки**: `"Hello World"`
- **Булеві значення**: `true`, `false`
- **Списки**: `[1, 2, 3, "test"]`
- **Словники**: `{"key": "value", "id": 123}`
- **None**: порожнє значення (ключове слово `None`)

### Коментарі
```python
# Це однорядковий коментар
// Це також коментар (стиль C)
```

## Керування потоком

### Умовні оператори
```python
if x > 10:
    print("Більше 10")
elif x == 10:
    print("Рівно 10")
else:
    print("Менше 10")
```

### Цикли
#### Цикл `while`
```python
let i = 0
while i < 5:
    print(i)
    set i = i + 1
```

#### Цикл `for`
```python
for i in range(5):
    print(i)

let items = ["apple", "banana", "cherry"]
for item in items:
    print(item)
```

#### Керування циклами
Для керування виконанням циклів використовуються ключові слова `break` та `continue`:
- `break` — негайно перериває цикл.
- `continue` — переходить до наступної ітерації циклу.

```python
let i = 0
while true:
    set i++
    if i == 5:
        continue # Пропустити 5
    if i > 10:
        break    # Зупинити цикл
    print(i)
```

### Ключове слово `yield`
`yield` — це спеціальна інструкція, яка призупиняє виконання макросу до наступного ігрового такту (tick).
Це корисно для створення довгих циклів, які не повинні блокувати інтерфейс або інші процеси.
```python
while true:
    # Робимо щось
    yield # Чекаємо наступного такту
```

### Функції
Функції оголошуються за допомогою ключового слова `func`. TML підтримує аргументи за замовчуванням та іменовані аргументи.

```python
# Функція з аргументом за замовчуванням та **kwargs
func greet(name, prefix="Привіт", **extra):
    print(prefix, name)
    if len(extra) > 0:
        print("Додатково:", extra)

# Різні способи виклику:
greet("Олексій")                      # Привіт Олексій
greet("Анна", prefix="Вітання")        # Вітання Анна
greet("Іван", status="online")         # Привіт Іван (extra={"status": "online"})
```

let result = add(5, 10)
```

## Спеціальні функції макросу
Ці функції викликаються автоматично середовищем виконання:

- `on_init()`: Викликається один раз при запуску макросу.
- `on_tick(delta)`: Викликається кожного ігрового такту. `delta` — час у секундах з останнього такту.
- `on_exit()`: Викликається перед зупинкою макросу.

```python
func on_init():
    print("Макрос запущено!")

func on_tick(delta):
    # Логіка, що виконується постійно
    pass

func on_exit():
    print("Макрос зупинено.")
```

## Оператори
- **Арифметичні**: `+`, `-`, `*`, `/`
- **Інкремент/Декримент**: `++`, `--` (наприклад, `set x++`). Оптимізовано для глобальних змінних.
- **Комбіноване присвоєння**: `+=`, `-=`, `*=`, `/=` (наприклад, `set x += 5`). Оптимізовано для швидкого виконання.
- **Порівняння**: `==`, `!=`, `>`, `<`, `>=`, `<=`
- **Логічні**: `and`, `or`, `not`
- **Доступ до властивостей**: `obj.property` (наприклад, `mouse.x`). Оптимізовано через `SET_ATTR_FAST`.

## Вбудовані функції та константи
Ці функції доступні глобально без імпорту модулів:

### Основні функції
- `print(value1, value2, ...)` — вивід повідомлень у консоль редактора.
- `sleep(seconds)` — призупинити виконання макросу на вказану кількість секунд.
- `range(stop)` або `range(start, stop)` — генерує послідовність чисел для циклу `for`.
- `len(collection)` — повертає кількість елементів у списку або символів у рядку.
- `type(value)` — повертає тип об'єкта.
- `exit()` або `stop()` — негайно зупиняє виконання поточного макросу.

### Перетворення типів
- `int(value)` — перетворює значення у ціле число.
- `float(value)` — перетворює значення у число з плаваючою крапкою.
- `str(value)` — перетворює значення у рядок.

### Константи та класи
- `None` — представлення порожнього значення.
- `Key` — доступ до перерахування спеціальних клавіш бібліотеки pynput (для розширеного використання).
- `left`, `right`, `middle` — константи для кнопок миші.
- Клавішні константи: `K_A`...`K_Z`, `K_0`...`K_9`, `K_ENTER`, `K_SPACE` тощо (повний список у документації модулів).
